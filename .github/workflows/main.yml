name: CI/CD Pipeline

on:
    push:
        branches:
            - master
            - develop
    pull_request:
        branches:
            - master
            - develop

env:
    DOCKER_BACKEND_IMAGE: ecommerce-backend
    DOCKER_ADMIN_IMAGE: ecommerce-admin
    DOCKER_FRONTEND_IMAGE: ecommerce-frontend
    BACKEND_CONTAINER_NAME: ecommerce-backend
    ADMIN_CONTAINER_NAME: ecommerce-admin
    FRONTEND_CONTAINER_NAME: ecommerce-frontend

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PEM }}

            - name: Add SSH known hosts
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1 || true
                  chmod 644 ~/.ssh/known_hosts
                  echo "Known hosts updated:"
                  cat ~/.ssh/known_hosts

            - name: Test SSH Connection
              run: |
                  echo "Testing SSH connection to server..."
                  ssh -i ~/.ssh/key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    echo "âœ“ SSH connection successful!"
                    echo "Server hostname: $(hostname)"
                    echo "Server uptime: $(uptime -p)"
                    echo "Docker version: $(docker --version)"
                    echo "Available disk space:"
                    df -h / | tail -1
                    echo "Memory usage:"
                    free -h | grep Mem
                  EOF
                  echo "SSH test completed successfully!"

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Backend Docker Image
              run: |
                  docker build -t ${{ env.DOCKER_BACKEND_IMAGE }}:${{ github.sha }} ./Backend

            - name: Build Admin Docker Image
              run: |
                  docker build -t ${{ env.DOCKER_ADMIN_IMAGE }}:${{ github.sha }} \
                    --build-arg VITE_BACKEND_URL=${{ secrets.VITE_ADMIN_BACKEND_URL }} \
                    --build-arg VITE_BLOB_URL=${{ secrets.VITE_BLOB_URL }} \
                    ./Admin

            - name: Build Frontend Docker Image
              run: |
                  docker build -t ${{ env.DOCKER_FRONTEND_IMAGE }}:${{ github.sha }} \
                    --build-arg VITE_BACKEND_URL=${{ secrets.VITE_FRONTEND_BACKEND_URL }} \
                    --build-arg VITE_BLOB_URL=${{ secrets.VITE_BLOB_URL }} \
                    ./Frontend

            - name: Save Docker Images
              run: |
                  docker save ${{ env.DOCKER_BACKEND_IMAGE }}:${{ github.sha }} | gzip > backend-image.tar.gz
                  docker save ${{ env.DOCKER_ADMIN_IMAGE }}:${{ github.sha }} | gzip > admin-image.tar.gz
                  docker save ${{ env.DOCKER_FRONTEND_IMAGE }}:${{ github.sha }} | gzip > frontend-image.tar.gz

            - name: Copy Docker Images to Server
              run: |
                  scp -i ~/.ssh/key.pem backend-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
                  scp -i ~/.ssh/key.pem admin-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
                  scp -i ~/.ssh/key.pem frontend-image.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

            - name: Deploy to Server
              run: |
                  ssh -i ~/.ssh/key.pem ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    # Load Docker images
                    docker load < /tmp/backend-image.tar.gz
                    docker load < /tmp/admin-image.tar.gz
                    docker load < /tmp/frontend-image.tar.gz

                    # Clean up transferred files
                    rm /tmp/backend-image.tar.gz /tmp/admin-image.tar.gz /tmp/frontend-image.tar.gz

                    # Create network if it doesn't exist
                    docker network create ecommerce-network || true

                    # Stop and remove old application containers
                    docker stop ${{ env.BACKEND_CONTAINER_NAME }} || true
                    docker rm ${{ env.BACKEND_CONTAINER_NAME }} || true
                    docker stop ${{ env.ADMIN_CONTAINER_NAME }} || true
                    docker rm ${{ env.ADMIN_CONTAINER_NAME }} || true
                    docker stop ${{ env.FRONTEND_CONTAINER_NAME }} || true
                    docker rm ${{ env.FRONTEND_CONTAINER_NAME }} || true

                    # Run Backend Container
                    docker run -d \
                      --name ${{ env.BACKEND_CONTAINER_NAME }} \
                      --network ecommerce-network \
                      -p 5000:5000 \
                      -e MONGODB_URL="${{ secrets.MONGODB_URL }}" \
                      -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
                      -e BLAK_RATT_IMAGE_CONTAINER_NAME="${{ secrets.BLAK_RATT_IMAGE_CONTAINER_NAME }}" \
                      -e AZURE_IMAGE_URL="${{ secrets.AZURE_IMAGE_URL }}" \
                      -e BLAK_RATT_DASHBOARD_IMAGE_CONTAINER_NAME="${{ secrets.BLAK_RATT_DASHBOARD_IMAGE_CONTAINER_NAME }}" \
                      -e AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
                      -e CLIENT_ORIGIN_1="${{ secrets.CLIENT_ORIGIN_1 }}" \
                      -e CLIENT_ORIGIN_2="${{ secrets.CLIENT_ORIGIN_2 }}" \
                      -e COOKIE_SECRET="${{ secrets.COOKIE_SECRET }}" \
                      -e PORT="${{ secrets.PORT }}" \
                      -e AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                      -e NGROK_AUTH_TOKEN="${{ secrets.NGROK_AUTH_TOKEN }}" \
                      -e PAYSTACK_SECRETE_KEY="${{ secrets.PAYSTACK_SECRETE_KEY }}" \
                      -e AZURE_COMMUNICATION_CONNECTION_STRING="${{ secrets.AZURE_COMMUNICATION_CONNECTION_STRING }}" \
                      -e AZURE_SENDER_ADDRESS="${{ secrets.AZURE_SENDER_ADDRESS }}" \
                      --restart unless-stopped \
                      --health-cmd="wget -q --spider http://localhost:5000/health || exit 1" \
                      --health-interval=30s \
                      --health-timeout=10s \
                      --health-retries=3 \
                      --health-start-period=10s \
                      ${{ env.DOCKER_BACKEND_IMAGE }}:${{ github.sha }}

                    # Wait for Backend to be ready
                    echo "Waiting for Backend to be ready..."
                    sleep 10

                    # Run Admin Container
                    docker run -d \
                      --name ${{ env.ADMIN_CONTAINER_NAME }} \
                      --network ecommerce-network \
                      -p 3001:80 \
                      --restart unless-stopped \
                      --health-cmd="wget -q --spider http://localhost/ || exit 1" \
                      --health-interval=30s \
                      --health-timeout=10s \
                      --health-retries=3 \
                      ${{ env.DOCKER_ADMIN_IMAGE }}:${{ github.sha }}

                    # Run Frontend Container
                    docker run -d \
                      --name ${{ env.FRONTEND_CONTAINER_NAME }} \
                      --network ecommerce-network \
                      -p 3000:80 \
                      --restart unless-stopped \
                      --health-cmd="wget -q --spider http://localhost/ || exit 1" \
                      --health-interval=30s \
                      --health-timeout=10s \
                      --health-retries=3 \
                      ${{ env.DOCKER_FRONTEND_IMAGE }}:${{ github.sha }}

                    # Clean up old images (keep last 3 versions)
                    echo "Cleaning up old images..."
                    docker images ${{ env.DOCKER_BACKEND_IMAGE }} --format "{{.Tag}}" | grep -v "latest" | tail -n +4 | xargs -r -I {} docker rmi ${{ env.DOCKER_BACKEND_IMAGE }}:{} || true
                    docker images ${{ env.DOCKER_ADMIN_IMAGE }} --format "{{.Tag}}" | grep -v "latest" | tail -n +4 | xargs -r -I {} docker rmi ${{ env.DOCKER_ADMIN_IMAGE }}:{} || true
                    docker images ${{ env.DOCKER_FRONTEND_IMAGE }} --format "{{.Tag}}" | grep -v "latest" | tail -n +4 | xargs -r -I {} docker rmi ${{ env.DOCKER_FRONTEND_IMAGE }}:{} || true
                    docker image prune -f

                    echo "Deployment completed successfully!"
                  EOF

            - name: Verify Deployment
              run: |
                  ssh -i ~/.ssh/key.pem ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    echo "=== Backend Container Status ==="
                    docker ps -f name=${{ env.BACKEND_CONTAINER_NAME }}
                    echo ""
                    echo "=== Admin Container Status ==="
                    docker ps -f name=${{ env.ADMIN_CONTAINER_NAME }}
                    echo ""
                    echo "=== Frontend Container Status ==="
                    docker ps -f name=${{ env.FRONTEND_CONTAINER_NAME }}
                    echo ""
                    echo "=== Backend Health Check ==="
                    curl -f http://localhost:5000/health || echo "Backend health check failed"
                    echo ""
                    echo "=== Backend Logs (last 20 lines) ==="
                    docker logs --tail 20 ${{ env.BACKEND_CONTAINER_NAME }} || echo "Container not running"
                    echo ""
                    echo "=== Admin Logs (last 20 lines) ==="
                    docker logs --tail 20 ${{ env.ADMIN_CONTAINER_NAME }} || echo "Container not running"
                    echo ""
                    echo "=== Frontend Logs (last 20 lines) ==="
                    docker logs --tail 20 ${{ env.FRONTEND_CONTAINER_NAME }} || echo "Container not running"
                    echo ""
                    echo "=== Deployed Image Tags ==="
                    docker inspect ${{ env.BACKEND_CONTAINER_NAME }} --format='{{.Config.Image}}' || echo "Backend container not found"
                    docker inspect ${{ env.ADMIN_CONTAINER_NAME }} --format='{{.Config.Image}}' || echo "Admin container not found"
                    docker inspect ${{ env.FRONTEND_CONTAINER_NAME }} --format='{{.Config.Image}}' || echo "Frontend container not found"
                  EOF

            - name: Cleanup SSH Key
              if: always()
              run: |
                  rm -f ~/.ssh/key.pem