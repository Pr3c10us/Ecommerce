# ===== Ecommerce Docker Compose =====
# Orchestrates all services: Backend, Admin, Frontend, and MongoDB

version: '3.8'

services:
  # ---- Backend API ----
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: ecommerce-backend
    restart: unless-stopped
    environment:
      - MONGODB_URL= ${MONGODB_URL}
      - JWT_SECRET= ${JWT_SECRET}
      - BLAK_RATT_IMAGE_CONTAINER_NAME= ${BLAK_RATT_IMAGE_CONTAINER_NAME}
      - AZURE_IMAGE_URL= ${AZURE_IMAGE_URL}
      - BLAK_RATT_DASHBOARD_IMAGE_CONTAINER_NAME= ${BLAK_RATT_DASHBOARD_IMAGE_CONTAINER_NAME}
      - AZURE_STORAGE_ACCOUNT_NAME= ${AZURE_STORAGE_ACCOUNT_NAME}
      - CLIENT_ORIGIN_1= ${CLIENT_ORIGIN_1}
      - CLIENT_ORIGIN_2= ${CLIENT_ORIGIN_2}
      - COOKIE_SECRET= ${COOKIE_SECRET}
      - PORT= ${PORT}
      - AZURE_STORAGE_CONNECTION_STRING= ${AZURE_STORAGE_CONNECTION_STRING}
      - NGROK_AUTH_TOKEN= ${NGROK_AUTH_TOKEN}
      - PAYSTACK_SECRETE_KEY= ${PAYSTACK_SECRETE_KEY}
      - AZURE_COMMUNICATION_CONNECTION_STRING= ${AZURE_COMMUNICATION_CONNECTION_STRING}
      - AZURE_SENDER_ADDRESS= ${AZURE_SENDER_ADDRESS}
    ports:
      - "5000:5000"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---- Admin Panel ----
  admin:
    build:
      context: ./Admin
      dockerfile: Dockerfile
    container_name: ecommerce-admin
    restart: unless-stopped
    ports:
      - "3001:80"
    environment:
      - VITE_API_URL= ${VITE_ADMIN_API_URL}
      - VITE_BLOB_URL= ${VITE_BLOB_URL}
    depends_on:
      - backend
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---- Customer Frontend ----
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: ecommerce-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      - VITE_API_URL= ${VITE_FRONTEND_API_URL}
      - VITE_BLOB_URL= ${VITE_BLOB_URL}
    depends_on:
      - backend
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  ecommerce-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
